if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

echo "# install jq"

if [[ <<parameters.version>> == "latest" ]]; then
  echo "# extract latest version from GitHub releases API"
  JQ_VERSION_STRING=$(curl --silent --show-error --location --fail --retry 3 \
    https://api.github.com/repos/stedolan/jq/releases/latest | grep tag_name | sed -E 's/"/%/g')

  IFS='%'; arrJQ_VERSION=($JQ_VERSION_STRING); unset IFS

  JQ_VERSION=${arrJQ_VERSION[3]}

else
  JQ_VERSION=<<parameters.version>>
fi

echo "# get source download URL for specified version"
if [[ $(curl --silent --show-error --location --fail --retry 3 \
  "https://api.github.com/repos/stedolan/jq/releases/tags/$JQ_VERSION" | \
  grep browser_download_url | grep -o -e 'https.*tar.gz') ]]; then

  JQ_SOURCE_URL=$(curl --silent --show-error --location --fail --retry 3 \
  "https://api.github.com/repos/stedolan/jq/releases/tags/$JQ_VERSION" | \
  grep browser_download_url | grep -o -e 'https.*tar.gz')
else
  JQ_SOURCE_URL="https://github.com/stedolan/jq/archive/$JQ_VERSION.tar.gz"
fi

echo "# download jq"
curl -O --silent --show-error --location --fail --retry 3 \
  "$JQ_SOURCE_URL"

tar xf "$JQ_VERSION.tar.gz" && rm -rf "$JQ_VERSION.tar.gz"

echo "# extract version number"
JQ_VERSION_NUMBER_STRING=$(echo $JQ_VERSION | sed -E 's/-/ /')

arrJQ_VERSION_NUMBER=($JQ_VERSION_NUMBER_STRING)

JQ_VERSION_NUMBER="${arrJQ_VERSION_NUMBER[1]}"

echo "# get binary download URL for specified version"
JQ_BINARY_URL=$(curl --silent --show-error --location --fail --retry 3 \
  "https://api.github.com/repos/stedolan/jq/releases/tags/$JQ_VERSION" | \
  grep browser_download_url | grep '/jq-linux.*64.*"' | grep -o -e 'https.*jq-linux.*64.*' | sed -E 's%"%%g')

if [ -d "$JQ_VERSION/sig" ]; then
  echo "# import jq sigs"
  if uname -a | grep Darwin; then
    brew install gnupg
  fi

  gpg --import "$JQ_VERSION/sig/jq-release.key"

  curl --output "$JQ_VERSION/sig/v$JQ_VERSION_NUMBER/jq-linux64" \
    --silent --show-error --location --fail --retry 3 \
    "$JQ_BINARY_URL"

  echo "# verify sha256sum, sig, install"
  gpg --verify "$JQ_VERSION/sig/v$JQ_VERSION_NUMBER/jq-linux64.asc"

  cd "$JQ_VERSION/sig/v$JQ_VERSION_NUMBER" && grep jq-linux64 "sha256sum.txt" | \
    sha256sum -c -
else
  curl --output jq-linux64 \
    --silent --show-error --location --fail --retry 3 \
    "$JQ_BINARY_URL"
fi

$SUDO mv jq-linux64 <<parameters.install-dir>>/jq
$SUDO chmod +x <<parameters.install-dir>>/jq

echo "# verify version"
which jq
jq --version
